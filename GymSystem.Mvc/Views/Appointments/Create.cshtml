@model GymSystem.Mvc.Models.CreateAppointmentViewModel

@{
    ViewData["Title"] = "Yeni Randevu Al";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0"><i class="bi bi-calendar-plus"></i> Yeni Randevu Al</h2>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post" id="appointmentForm">
                        @Html.AntiForgeryToken()
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <div class="row">
                            @if (User.IsInRole("Member"))
                            {
                                <!-- Member için hidden input -->
                                <input type="hidden" asp-for="MemberId" value="@ViewBag.CurrentMemberId" />
                                <div class="col-md-12 mb-3">
                                    <div class="alert alert-info">
                                        <i class="bi bi-person-check"></i> <strong>Üye:</strong> @ViewBag.CurrentMemberName
                                    </div>
                                </div>
                            }
                            else
                            {
                                <!-- Admin ve GymOwner için dropdown -->
                                <div class="col-md-6 mb-3">
                                    <label asp-for="MemberId" class="form-label">Üye *</label>
                                    <select asp-for="MemberId" class="form-select" asp-items="@ViewBag.Members">
                                        <option value="">-- Üye Seçiniz --</option>
                                    </select>
                                    <span asp-validation-for="MemberId" class="text-danger"></span>
                                </div>
                            }

                            <div class="@(User.IsInRole("Member") ? "col-md-12" : "col-md-6") mb-3">
                                <label asp-for="GymLocationId" class="form-label">Spor Salonu *</label>
                                <select asp-for="GymLocationId" class="form-select" asp-items="@ViewBag.GymLocations" id="gymLocationSelect">
                                    <option value="">-- Spor Salonu Seçiniz --</option>
                                </select>
                                <span asp-validation-for="GymLocationId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="ServiceId" class="form-label">Hizmet *</label>
                                <select asp-for="ServiceId" class="form-select" id="serviceSelect" disabled>
                                    <option value="">-- Önce Salon Seçiniz --</option>
                                </select>
                                <span asp-validation-for="ServiceId" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="TrainerId" class="form-label">Antrenör *</label>
                                <select asp-for="TrainerId" class="form-select" id="trainerSelect" disabled>
                                    <option value="">-- Önce Hizmet Seçiniz --</option>
                                </select>
                                <span asp-validation-for="TrainerId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="AppointmentDate" class="form-label">Randevu Tarihi *</label>
                                <input asp-for="AppointmentDate" type="date" class="form-control" min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                <span asp-validation-for="AppointmentDate" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="AppointmentTime" class="form-label">Randevu Saati *</label>
                                <input asp-for="AppointmentTime" type="time" class="form-control" />
                                <span asp-validation-for="AppointmentTime" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Notes" class="form-label">Notlar</label>
                            <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Özel bir isteğiniz varsa buraya yazabilirsiniz..."></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>

                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Bilgi:</strong> Randevunuz oluşturulduktan sonra onay bekleyecektir. Antrenör veya admin tarafından onaylandığında kesinleşecektir.
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Geri
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-calendar-check"></i> Randevu Al
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Salon seçildiğinde hizmetleri yükle
            $('#gymLocationSelect').on('change', function() {
                var gymLocationId = $(this).val();
                var serviceSelect = $('#serviceSelect');
                var trainerSelect = $('#trainerSelect');
                
                serviceSelect.prop('disabled', true).html('<option value="">Yükleniyor...</option>');
                trainerSelect.prop('disabled', true).html('<option value="">-- Önce Hizmet Seçiniz --</option>');
                
                if (gymLocationId) {
                    $.ajax({
                        url: '@Url.Action("GetServicesByGym")',
                        type: 'GET',
                        data: { gymLocationId: gymLocationId },
                        success: function(data) {
                            serviceSelect.empty();
                            if (data && data.length > 0) {
                                serviceSelect.append('<option value="">-- Hizmet Seçiniz --</option>');
                                $.each(data, function(index, service) {
                                    serviceSelect.append('<option value="' + service.id + '">' + 
                                        service.name + ' (' + service.durationMinutes + ' dk - ₺' + service.price.toFixed(2) + ')</option>');
                                });
                                serviceSelect.prop('disabled', false);
                            } else {
                                serviceSelect.append('<option value="">Bu salonda hizmet bulunamadı</option>');
                            }
                        },
                        error: function() {
                            serviceSelect.html('<option value="">Hizmetler yüklenemedi</option>');
                        }
                    });
                } else {
                    serviceSelect.html('<option value="">-- Önce Salon Seçiniz --</option>');
                }
            });

            // Hizmet seçildiğinde antrenörleri yükle
            $('#serviceSelect').on('change', function() {
                var serviceId = $(this).val();
                var trainerSelect = $('#trainerSelect');
                
                trainerSelect.prop('disabled', true).html('<option value="">Yükleniyor...</option>');
                
                if (serviceId) {
                    $.ajax({
                        url: '@Url.Action("GetTrainersByService")',
                        type: 'GET',
                        data: { serviceId: serviceId },
                        success: function(data) {
                            trainerSelect.empty();
                            if (data && data.length > 0) {
                                trainerSelect.append('<option value="">-- Antrenör Seçiniz --</option>');
                                $.each(data, function(index, trainer) {
                                    trainerSelect.append('<option value="' + trainer.id + '">' + 
                                        trainer.firstName + ' ' + trainer.lastName + '</option>');
                                });
                                trainerSelect.prop('disabled', false);
                            } else {
                                trainerSelect.append('<option value="">Bu hizmet için antrenör bulunamadı</option>');
                            }
                        },
                        error: function() {
                            trainerSelect.html('<option value="">Antrenörler yüklenemedi</option>');
                        }
                    });
                } else {
                    trainerSelect.html('<option value="">-- Önce Hizmet Seçiniz --</option>');
                }
            });
        });
    </script>
}
