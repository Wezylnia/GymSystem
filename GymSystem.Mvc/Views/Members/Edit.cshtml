@model GymSystem.Mvc.Models.EditMemberViewModel

@{
    ViewData["Title"] = "Üye Düzenle";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h2 class="mb-0">
                        <i class="bi bi-pencil"></i> Üye Düzenle
                    </h2>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FirstName" class="form-label">
                                    <i class="bi bi-person"></i> Ad *
                                </label>
                                <input asp-for="FirstName" 
                                       type="text" 
                                       class="form-control" 
                                       placeholder="Adýnýz"
                                       pattern="[a-zA-ZðüþýöçÐÜÞÝÖÇ\s]{2,100}"
                                       maxlength="100"
                                       autocomplete="given-name"
                                       required />
                                <span asp-validation-for="FirstName" class="text-danger small"></span>
                                <div class="form-text">
                                    <small>Sadece harf ve boþluk, en az 2 karakter</small>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="LastName" class="form-label">
                                    <i class="bi bi-person"></i> Soyad *
                                </label>
                                <input asp-for="LastName" 
                                       type="text" 
                                       class="form-control" 
                                       placeholder="Soyadýnýz"
                                       pattern="[a-zA-ZðüþýöçÐÜÞÝÖÇ\s]{2,100}"
                                       maxlength="100"
                                       autocomplete="family-name"
                                       required />
                                <span asp-validation-for="LastName" class="text-danger small"></span>
                                <div class="form-text">
                                    <small>Sadece harf ve boþluk, en az 2 karakter</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label asp-for="Gender" class="form-label">
                                    <i class="bi bi-gender-ambiguous"></i> Cinsiyet *
                                </label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="Gender" id="genderMale" value="1" 
                                           checked="@(Model.Gender == GymSystem.Domain.Enums.Gender.Male ? "checked" : null)"
                                           asp-for="Gender" />
                                    <label class="btn btn-outline-primary" for="genderMale">
                                        <i class="bi bi-gender-male"></i> Erkek
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="Gender" id="genderFemale" value="0" 
                                           checked="@(Model.Gender == GymSystem.Domain.Enums.Gender.Female ? "checked" : null)"
                                           asp-for="Gender" />
                                    <label class="btn btn-outline-danger" for="genderFemale">
                                        <i class="bi bi-gender-female"></i> Kadýn
                                    </label>
                                </div>
                                <span asp-validation-for="Gender" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label">
                                    <i class="bi bi-envelope"></i> Email *
                                </label>
                                <input asp-for="Email" 
                                       type="email" 
                                       class="form-control" 
                                       placeholder="ornek@email.com"
                                       maxlength="200"
                                       autocomplete="email"
                                       required />
                                <span asp-validation-for="Email" class="text-danger small"></span>
                                <div class="form-text">
                                    <small>Geçerli bir email adresi giriniz</small>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="PhoneNumber" class="form-label">
                                    <i class="bi bi-phone"></i> Telefon
                                </label>
                                <input asp-for="PhoneNumber" 
                                       type="tel" 
                                       class="form-control" 
                                       placeholder="05XXXXXXXXX"
                                       pattern="^(05)[0-9]{9}$"
                                       maxlength="11"
                                       autocomplete="tel"
                                       id="phoneInput" />
                                <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                                <div class="form-text">
                                    <small><i class="bi bi-info-circle"></i> 05 ile baþlamalý, 11 haneli olmalý (örn: 05321234567)</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="MembershipStartDate" class="form-label">
                                    <i class="bi bi-calendar-check"></i> Üyelik Baþlangýç Tarihi
                                </label>
                                <input asp-for="MembershipStartDate" 
                                       type="date" 
                                       class="form-control" 
                                       max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                <span asp-validation-for="MembershipStartDate" class="text-danger small"></span>
                                <div class="form-text">
                                    <small>Bugünden önceki bir tarih seçiniz</small>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="MembershipEndDate" class="form-label">
                                    <i class="bi bi-calendar-x"></i> Üyelik Bitiþ Tarihi
                                </label>
                                <input asp-for="MembershipEndDate" 
                                       type="date" 
                                       class="form-control"
                                       min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                <span asp-validation-for="MembershipEndDate" class="text-danger small"></span>
                                <div class="form-text">
                                    <small><i class="bi bi-info-circle"></i> Boþ býrakýlýrsa üyelik süresi olmayacak. Baþlangýç tarihinden sonra olmalýdýr.</small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3 form-check">
                            <input asp-for="IsActive" class="form-check-input" />
                            <label asp-for="IsActive" class="form-check-label">
                                Üye Aktif
                            </label>
                            <div class="form-text">Pasif yapýlýrsa üye sisteme giriþ yapamaz</div>
                        </div>

                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Dikkat:</strong> Email deðiþikliði kullanýcýnýn giriþ bilgilerini etkileyebilir.
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Geri
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-save"></i> Güncelle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Ýsim ve soyad sadece harf (Türkçe karakterler dahil)
            $('#FirstName, #LastName').on('input', function() {
                const turkishLetters = /^[a-zA-ZðüþýöçÐÜÞÝÖÇ\s]*$/;
                if (!turkishLetters.test(this.value)) {
                    this.value = this.value.replace(/[^a-zA-ZðüþýöçÐÜÞÝÖÇ\s]/g, '');
                }
                
                // Ýlk harfi büyük yap
                const words = this.value.split(' ');
                this.value = words.map(word => {
                    if (word.length > 0) {
                        return word.charAt(0).toLocaleUpperCase('tr-TR') + word.slice(1).toLocaleLowerCase('tr-TR');
                    }
                    return word;
                }).join(' ');
                
                // Gerçek zamanlý validasyon
                if (this.value.length >= 2) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (this.value.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });

            // Email validasyonu ve küçük harfe çevirme
            $('#Email').on('input', function() {
                this.value = this.value.toLowerCase().trim();
                
                // Email regex
                const emailRegex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (emailRegex.test(this.value)) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else if (this.value.length > 0) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });

            // Telefon numarasý formatý (sadece rakam, 05 ile baþlamalý, 11 haneli)
            $('#PhoneNumber').on('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                
                // Gerçek zamanlý validasyon
                if (this.value.length > 0) {
                    if (this.value.length === 11 && this.value.startsWith('05')) {
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    } else {
                        $(this).removeClass('is-valid').addClass('is-invalid');
                    }
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            // Tarih validasyonlarý
            $('#MembershipStartDate, #MembershipEndDate').on('change', function() {
                validateDates();
            });

            function validateDates() {
                const startDate = $('#MembershipStartDate').val();
                const endDate = $('#MembershipEndDate').val();
                
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    if (end <= start) {
                        $('#MembershipEndDate').removeClass('is-valid').addClass('is-invalid');
                        if (!$('#dateError').length) {
                            $('#MembershipEndDate').after('<div id="dateError" class="text-danger small mt-1">Bitiþ tarihi, baþlangýç tarihinden sonra olmalýdýr</div>');
                        }
                    } else {
                        $('#MembershipEndDate').removeClass('is-invalid').addClass('is-valid');
                        $('#dateError').remove();
                    }
                } else {
                    $('#MembershipEndDate').removeClass('is-invalid is-valid');
                    $('#dateError').remove();
                }
            }

            // Form submit kontrolü
            $('form').submit(function(e) {
                let isValid = true;
                
                // Ýsim kontrolü
                const firstName = $('#FirstName').val().trim();
                if (firstName.length < 2) {
                    $('#FirstName').addClass('is-invalid');
                    isValid = false;
                }
                
                // Soyad kontrolü
                const lastName = $('#LastName').val().trim();
                if (lastName.length < 2) {
                    $('#LastName').addClass('is-invalid');
                    isValid = false;
                }
                
                // Email kontrolü
                const email = $('#Email').val().trim();
                const emailRegex = /^[a-zA-Z0-9._%+-]+@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                if (!emailRegex.test(email)) {
                    $('#Email').addClass('is-invalid');
                    isValid = false;
                }
                
                // Telefon kontrolü (opsiyonel ama girilmiþse doðru formatta olmalý)
                const phone = $('#PhoneNumber').val();
                if (phone.length > 0 && (phone.length !== 11 || !phone.startsWith('05'))) {
                    $('#PhoneNumber').addClass('is-invalid');
                    isValid = false;
                }
                
                // Tarih kontrolü
                const startDate = $('#MembershipStartDate').val();
                const endDate = $('#MembershipEndDate').val();
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    if (end <= start) {
                        $('#MembershipEndDate').addClass('is-invalid');
                        isValid = false;
                    }
                }
                
                if (!isValid) {
                    e.preventDefault();
                    
                    // Ýlk hatalý alana scroll
                    const firstInvalid = $('.is-invalid').first();
                    if (firstInvalid.length) {
                        $('html, body').animate({
                            scrollTop: firstInvalid.offset().top - 100
                        }, 500);
                    }
                    
                    // Hata mesajý göster
                    if (!$('#validationError').length) {
                        $('.card-body').prepend(
                            '<div id="validationError" class="alert alert-danger alert-dismissible fade show" role="alert">' +
                            '<i class="bi bi-exclamation-triangle"></i> ' +
                            '<strong>Uyarý:</strong> Lütfen tüm zorunlu alanlarý doðru formatta doldurunuz.' +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                            '</div>'
                        );
                    }
                    
                    return false;
                }
                
                // Loading state
                const submitBtn = $(this).find('button[type="submit"]');
                submitBtn.prop('disabled', true);
                submitBtn.html('<span class="spinner-border spinner-border-sm me-2"></span>Güncelleniyor...');
            });

            // Bootstrap validasyon stillerini ekle
            $('input').on('blur', function() {
                if ($(this).val().length > 0 && !$(this).hasClass('is-valid') && !$(this).hasClass('is-invalid')) {
                    if (this.checkValidity()) {
                        $(this).addClass('is-valid');
                    } else {
                        $(this).addClass('is-invalid');
                    }
                }
            });
        });
    </script>
    
    <style>
        .is-valid {
            border-color: #198754 !important;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .is-invalid {
            border-color: #dc3545 !important;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .form-text {
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #6c757d;
        }
        
        .text-danger.small {
            font-size: 0.875em;
            margin-top: 0.25rem;
            display: block;
        }
    </style>
}
